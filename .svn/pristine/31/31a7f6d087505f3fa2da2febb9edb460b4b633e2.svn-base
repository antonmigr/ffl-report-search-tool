
using PresentationControls;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Data.SqlClient;
using System.Diagnostics;
using System.Drawing;
using System.Drawing.Printing;
using System.Globalization;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using Outlook = Microsoft.Office.Interop.Outlook;
using itextsharp;
using iTextSharp.text.pdf;
using iTextSharp.text;
using System.IO;
using System.Text.RegularExpressions;
using System.Security.Principal;
using System.Security.AccessControl;
using System.Net.Mail;
using MySql.Data.MySqlClient;

namespace DynamicQuery
{
    public partial class QueryBuilder : Form
    {
        private static String[,] FieldsArray = new String[19,9];
        private static String[,] FilterArray = new String[21,3];
        
        private int FieldsArrayCount = 0;
        private int FilterArrayCount = 0;
        private static int filterCount = 7;

        private ComboBox[] Field = new ComboBox[filterCount];
        private ComboBox[] Filter = new ComboBox[filterCount];
        private CheckBoxComboBox[] Value = new CheckBoxComboBox[filterCount];
        private PictureBox[] valid = new PictureBox[filterCount];

        private bool ENCRYPT_EMAIL = false;
  

        public QueryBuilder()
        {
            InitializeComponent();

            InitializeFilter(); 
            DrawFilterLines();

            insertintoFieldsArray("Customer", "Customer ID", "String", "String", "75", "customer", "1", "FactSamples", "CustomerID");
            insertintoFieldsArray("Customer", "Customer Name ", "String", "String", "225", "customer", "1", "FactSamples", "customername");
            insertintoFieldsArray("Customer", "State", "String", "List-SELECT Distinct state from FactSamples where shippingstate is not null order by shippingstate;", "45", "customer", "0", "FactSamples", "State");
            insertintoFieldsArray("Customer", "County", "String", "String", "135", "customer", "0", "FactSamples", "County");
            insertintoFieldsArray("Customer", "Primary Market", "String", "List-Select distinct primarymarket from FactSamples order by primarymarket ; ", "100", "customer", "0", "FactSamples ", "primarymarket ");
            insertintoFieldsArray("Customer", "Sales Rep", "String", "List-select distinct SalesRep from FactSamples where salesrepid is not null order by SalesRepID  ; ", "50", "customer", "0", "FactSamples", "SalesRep");
            insertintoFieldsArray("Customer", "Parent LIMS ID", "String", "String", "85", "customer", "0", "FactSamples", "parentlims");
            insertintoFieldsArray("Samples", "Lab ID", "String", "String", "75", "url", "1", "FactSamples", "labid");
            insertintoFieldsArray("Samples", "Spec ID", "String", "String", "85", "chain", "1", "FactSamples", "specimenid");
            insertintoFieldsArray("Samples", "Receive Date ", "Date", "Date", "70", "url", "1", "FactSamples", "ReceiveDate");
            insertintoFieldsArray("Samples", "Collect date", "Date", "Date", "70", "url", "1", "FactSamples", "CollectDate");
            insertintoFieldsArray("Samples", "Donor ", "String", "String", "130", "url", "1", "FactSamples", "Donor");
            insertintoFieldsArray("Samples", "Collector", "String", "String", "130", "url", "1", "FactSamples", "Collector");
            insertintoFieldsArray("Samples", "Sample Result", "String", "List-SELECT Distinct SampleResult from FactSamples where SampleResult is not null ;", "50", "url", "1", "FactSamples", "SampleResult");
          //  insertintoFieldsArray("Samples", "Portal URL", "String", "String", "275", "url", "0", "FactSamples", "'http://extranet/sites/' + customeridkey + extranetfilepath");
           // insertintoFieldsArray("Samples", "Patient OID ", "String", "String", "85", "url", "0", "FactSamples", "CONVERT(VARCHAR(50),DECRYPTBYKEY(OID))");
            insertintoFieldsArray("Samples", "Report  Date ", "Date", "Date", "80", "url", "0", "FactSamples", "ReportDate");
            insertintoFieldsArray("SampleDrugs", "Drug Name", "String", "List-select DrugName from FactSamples where drugsort is not null;", "200", "drug", "0", "FactSamples", "DrugName");
            insertintoFieldsArray("SampleDrugs", "Type", "String", "List-select distinct  DrugType from FactSamples where DrugType is not null ;", "85", "drug", "0", "FactSamples", "DrugType");
            insertintoFieldsArray("SampleDrugs", "Drug Result", "String", "List-select 'H' union select '.' union select 'C' union select 'P' union select '?' union select 'N' ; ", "50", "drug", "0", "FactSamples", "DrugResult");
            insertintoFieldsArray("SampleDrugs", "Drug Level", "String", "Number", "85", "drug", "0", "FactSamples", " ( case when DrugType='Header' then -1 else DrugResult end) ");

            insertintoFilterArray("String", "equals", " = '$$$'");
            insertintoFilterArray("String", "not equals", " != '$$$'");
            insertintoFilterArray("String", "contains", " like '%$$$%'");
            insertintoFilterArray("String", "does not contain", " not like '%$$$%'");
            insertintoFilterArray("String", "starts with", " like '$$$%'");
            insertintoFilterArray("String", "ends with", " like '%$$$'");
            insertintoFilterArray("String", "is blank", " is null ");
            insertintoFilterArray("String", "is not blank", " is not null ");
            insertintoFilterArray("Number", "equals", " =$$$");
            insertintoFilterArray("Number", "greater than ", " >$$$");
            insertintoFilterArray("Number", "less than ", " <$$$");
            insertintoFilterArray("Number", "is blank", " is null ");
            insertintoFilterArray("Number", "is not blank", " is not null ");
            insertintoFilterArray("Date", "does not equal", " != '$$$'");
            insertintoFilterArray("Date", "equals ", " = '$$$'");
            insertintoFilterArray("Date", "after or on ", " >='$$$'");
            insertintoFilterArray("Date", "before or on ", " <='$$$'");
            insertintoFilterArray("List", "in", " in ('$$$')");
            insertintoFilterArray("List", "not in ", " not in ('$$$')");
            insertintoFilterArray("List", "is blank", " is null ");
            insertintoFilterArray("List", "is not blank", " is not null ");

           // StepTwoGroupBox.Visible = false;
            button2.Visible = false;
            StepSwitchbutton2.Visible = false; 

            CartgroupBox.Visible = false;
            StepThreeGroupBox.Visible = false;
            ResultsdataGridView1.AllowUserToAddRows = false;
           
           // FilterValuetextBox.Visible = false;
           // filterdateTimePicker1.Visible = false;
           // FilterlistBox2.Visible = false;
            FillChoiceListBoxes();
        }

        private void InitializeFilter()
        {
            int xStart = 10;
            int yStart = 30;

            int xSpot = xStart;
            int ySpot = yStart;

            int xMargin = 5;
            int yMargin = 5;

            for (int i = 0; i < Field.Length; i++)
            {
                xSpot = xStart;

                Field[i] = new ComboBox();
                Field[i].Name = "Fields_" + i;
                Field[i].Location = new Point(xSpot, ySpot);
                xSpot += xMargin + Field[i].Width;
                Field[i].TextChanged += Control_Clicks;
                Field[i].KeyPress += myCombo_KeyPress; 
                StepTwoGroupBox.Controls.Add(Field[i]); 
                
                Filter[i] = new ComboBox();
                Filter[i].Name = "Filter_" + i;
                Filter[i].Location = new Point(xSpot, ySpot);
                xSpot += xMargin + Filter[i].Width;
                Filter[i].Show();
                Filter[i].TextChanged += Control_Clicks;
                StepTwoGroupBox.Controls.Add(Filter[i]);

                Value[i] = new CheckBoxComboBox();
                Value[i].Name = "Value_" + i;
                Value[i].Location = new Point(xSpot, ySpot);
                Value[i].TextChanged += Control_Clicks;
                xSpot += xMargin + Value[i].Width;
                StepTwoGroupBox.Controls.Add(Value[i]);
               
                valid[i] = new PictureBox();
                valid[i].Name = "valid_" + i;
                valid[i].Location = new Point(xSpot, ySpot);
                valid[i].Size = new Size(20, 20);
                xSpot += xMargin + valid[i].Width;
                valid[i].Visible = true;
               // valid[i].Image = System.Drawing.Image.FromFile("\\\\sbs1\\shared\\Temp\\x.png");
                StepTwoGroupBox.Controls.Add(valid[i]);

                ySpot += yMargin + Field[i].Height;
            }
        }

        private void myCombo_KeyPress(object sender, KeyPressEventArgs e)
        {
            e.Handled = true;
        }

        private void insertintoFieldsArray(String Category, String Field, String DataType, String FilterType, String Length, String Link,String selected , String dbTable, String dbField)
        {
            FieldsArray[FieldsArrayCount,0] = Category;
            FieldsArray[FieldsArrayCount,1] = Field;
            FieldsArray[FieldsArrayCount,2] = DataType;
            FieldsArray[FieldsArrayCount,3] = FilterType;
            FieldsArray[FieldsArrayCount,4] = Length;
            FieldsArray[FieldsArrayCount,5] = Link;
            FieldsArray[FieldsArrayCount, 6] = selected; // selected 
            FieldsArray[FieldsArrayCount, 7] = dbTable; 
            FieldsArray[FieldsArrayCount, 8] = dbField; 
            FieldsArrayCount++;           
        }
       
        private void insertintoFilterArray(String FilterType, String FilterText, String SQL)
        {
            FilterArray[FilterArrayCount, 0] = FilterType;
            FilterArray[FilterArrayCount, 1] = FilterText;
            FilterArray[FilterArrayCount, 2] = SQL;
            FilterArrayCount++;
        }
       
        private void FillChoiceListBoxes()
        {
            CustomerListBox.Items.Clear();
            SamplesListBox.Items.Clear();
            SampleDrugsListBox.Items.Clear();
            SelectedItemsListBox.Items.Clear();

            for (int x = 0; x < Field.Length; x++)
            {
                Field[x].Items.Clear();
            }

            for (int numRows = 0; numRows < FieldsArrayCount; numRows++)
            {
                if (FieldsArray[numRows, 6] == "1")
                {
                    SelectedItemsListBox.Items.Add(FieldsArray[numRows, 1].ToString());
                    //FilterFieldcomboBox.Items.Add(FieldsArray[numRows, 1].ToString());
                    for (int x = 0; x < Field.Length; x++)
                    {
                        Field[x].Items.Add(FieldsArray[numRows, 1].ToString());
                    }
                }
                else
                {
                    ListBox CurrentLB = this.Controls.Find(FieldsArray[numRows, 0] + "ListBox", true).First() as ListBox;
                    CurrentLB.Items.Add(FieldsArray[numRows, 1].ToString());

                }
            }
            
        }

        private void CustomerListBox_DoubleClick_1(object sender, EventArgs e)
        {
            FieldClicked(CustomerListBox,"1");
        }
       
        private void SamplesListBox_SelectedIndexChanged(object sender, EventArgs e)
        {
            FieldClicked(SamplesListBox, "1");
        }

        private void SampleDrugsListBox_SelectedIndexChanged(object sender, EventArgs e)
        {
            FieldClicked(SampleDrugsListBox, "1");
        }
       
        private void SelectedItemsListBox_DoubleClick(object sender, EventArgs e)
        {
            FieldClicked(SelectedItemsListBox, "0");
        }
       
        private void FieldClicked(ListBox ChosenLB,String Value)
        {
            if (ChosenLB.SelectedItem != null)
            {
                FieldsArray[getFieldsArrayIndex(ChosenLB.SelectedItem.ToString()), 6] = Value;
                FillChoiceListBoxes();
            } 
        }
       
        private int getFieldsArrayIndex(String str)
        {
            for (int numRows = 0; numRows < FieldsArrayCount; numRows++)
            {
                if (FieldsArray[numRows, 1] == str)
                {
                    //MessageBox.Show(str + "  " + FieldsArray[numRows, 1] + "  "+ numRows ); 
                    return numRows;
                }
            }
            return 0;
        }

        private void Control_Clicks(object sender, EventArgs e)
        {
            Control control = (Control)sender;   
            String name = control.Name.ToString();
            String controlType = name.Split('_')[0];
            int index = int.Parse(name.Split('_')[1]);

            ComboBox cb = null;
            if (control.GetType().ToString() == "System.Windows.Forms.ComboBox")
            {
                 cb = control as ComboBox; 
            }

            if (controlType == "Fields" && Field[index].Text != "" )
            {
                //filter type 
                Filter[index].Text = "";
                Filter[index].Items.Clear();
                int idx = getFieldsArrayIndex(Field[index].SelectedItem.ToString()); 
                String FilterType = FieldsArray[idx, 3].Split('-')[0];
            
                for (int i = 0; i < FilterArrayCount; i++)
                {
                    if (FilterType == FilterArray[i, 0])
                    {
                        Filter[index].Items.Add(FilterArray[i, 1]);
                    }
                }
                //filter value 
                if (FieldsArray[idx, 3] == "Date")
                {
                    Value[index].AllowDrop = false;
                    Value[index].Text = DateTime.Today.ToString("MM/dd/yyyy"); 
                    Value[index].DropDownHeight = 1;
                    Filter[index].Text = "after or on "; 
                }
                else if (FieldsArray[idx, 3].Substring(0, 4) == "List")
                {
                    fillListChoices(FieldsArray[idx, 3].Substring(5, FieldsArray[idx, 3].Length - 6), index);
                    Value[index].Text = "";
                    Value[index].DropDownHeight = 250;
                    Filter[index].Text = "in";
                }
                else
                {
                    Value[index].AllowDrop = false;
                    Value[index].Text = "";
                    Value[index].DropDownHeight = 1;
                    Filter[index].Text = "contains";
                }
            } 
            ValidateFilters(); 
        }

        private bool ValidateFilter(String fieldtxt, String filterTxt, String valuetxt)
        {
            if (fieldtxt != "")
            {
                if (FieldsArray[getFieldsArrayIndex(fieldtxt), 6] == "1")
                {
                    if (filterTxt != "" )
                    {
                        if (filterTxt.Contains("blank") || FieldsArray[getFieldsArrayIndex(fieldtxt), 3] != "Date" && valuetxt != "" || FieldsArray[getFieldsArrayIndex(fieldtxt), 3] == "Date" && isDate(valuetxt))
                        {
                              return true; 
                        }
                        else
                        {
                            ThrowError("no valid value given");
                        }
                    }
                    else
                    {
                        ThrowError("no filter type was selected ");
                    }
                }
                else
                {
                    ThrowError("This Fields was not selected in the selected list ");
                }
            }
            else
            {
                ThrowError("no field was selected ");
            }
            return false; 
        }

        private bool isDate(String dateTime)
        {
            string[] formats = {  "M/d/yyyy", "MM/d/yyyy", "MM/dd/yyyy", "M/dd/yyyy", "M/d/yy", "MM/d/yy", "MM/dd/yy", "M/dd/yy" };
            DateTime parsedDateTime;
            return DateTime.TryParseExact(dateTime, formats, new CultureInfo("en-US"),DateTimeStyles.None, out parsedDateTime);
        }

        private void ValidateFilters()
        {
            for (int x = 0; x < Field.Length; x++)
            {
                if (ValidateFilter(Field[x].Text, Filter[x].Text, Value[x].Text))
                {
                    valid[x].Width = 51;
                }
                else
                {
                    valid[x].Width = 50;
                }
            }
        }
 
        private String toCSV(CheckedListBox LB)
        {
            StringBuilder sb = new StringBuilder();
            char[] characters = new char[] { ' ', ',' };
            String trimmedString;

            for (int i = 0; i < LB.CheckedItems.Count; i++)
            {
                sb.Append(LB.CheckedItems[i].ToString() + ",");
            }

            trimmedString = sb.ToString().TrimEnd(characters);
            return trimmedString;
        }

        private int getSqlDate(DateTime date)
        {
            int returnval = date.Year * 10000 + date.Month * 100 + date.Day;
            return returnval;
        } 

        private void ThrowError(String errorMessage)
        {
            Console.Write(errorMessage+'\n');
        }
 
        private String BuildQuery()
        {
            //		OPEN SYMMETRIC KEY dimpatientskey DECRYPTION BY CERTIFICATE encryptcert
            String q = @"Select 100000X";
            int druglevel = 0; 
            for (int numRows = 0; numRows < FieldsArrayCount; numRows++)
            {
                if(FieldsArray[numRows,6]=="1")
                {
                    q+=", "+FieldsArray[numRows,8]+" ";
                    if ( FieldsArray[numRows,0] == "SampleDrugs")
                    {
                        druglevel = 1; 
                    }

                }
            }
            q = q.Replace("100000X,", " ");


          /* q += @" ,'http://extranet/sites/' + customeridkey + extranetfilepath as url
                    , c.primaryMarket as  primaryMarkethide 
                    , (select  top 1  'http://chains/Chains/'+leafname   from wss_content_chains.dbo.AllUserData u   inner join wss_content_chains.dbo.alldocs d on u.tp_DocId = d.id and u.tp_DeleteTransactionId = '' where u.tp_listid = 'B42B3A7B-54D1-4348-BCAD-679B9098C560'  and  nvarchar7 = concat(s.labidkey,'')) as coc 
                    ,concat(concat((select count(sequenceid) from factschedules fs2 where extranetfilepath is not null and   fs2.labid=fs.labid and   fs2.sequenceid<=fs.sequenceid ) 
				  ,'/'), (select count(sequenceid) from factschedules fs2 where extranetfilepath is not null and   fs2.labid=fs.labid ) ) as ReportVersion
                         FROM  FactSamples s
                    left outer  join (select * from factschedules where extranetfilepath is not null )  fs on s.labidkey=fs.labid
                    left outer  join dimcustomers c on c.customerid=s.customeridkey 
                    left outer  join dimdate rd on rd.datesk=s.ReceiveDateKey
                    left outer  join dimdate cd on cd.datesk=s.CollectDateKey
                    left outer  join DimPatients p on p.PatientID=s.PatientSequenceID 
                 ";
            if (druglevel == 1)
           {
               q += @"left outer join FactSampleDetails sd on sd.LabIDKey=s.LabIDKey
                        left outer join dimdrugs d on d.DrugID=sd.DrugIDKey
                    ";
           }
            */
           q += " from FactSamples";
             
           int First = 1;
           String FilterTemp = "";
           String ValueTemp = "";
           for (int i = 0; i < filterCount; i++)
           {
               FilterTemp=Filter[i].Text;
               ValueTemp=Value[i].Text;
               if (valid[i].Width == 51) 
               {
                   if (First == 1) { q += " WHERE 1=1 "; First = 0;  }
                   if (isDate(Value[i].Text))
                   {
                       q += "and " + CSVtoSQL(Field[i].Text + "_" + Filter[i].Text + "_" + getSqlDate(DateTime.Parse(Value[i].Text))); 
                   }
                   else
                   { 
                        String tempq = "and " + CSVtoSQL(Field[i].Text + "_" + Filter[i].Text + "_" + Value[i].Text.Replace(", ", ","));
                        
                       if (Filter[i].Text.Contains("equals") && Value[i].Text.Contains(","))
                        {
                            tempq=tempq.Replace(",", "','");
                            tempq = tempq.Replace("=", " in (");
                            tempq = tempq.Replace("!", " not ");
                            tempq += ")"; 
                            //FilterTemp = Filter[i].Text.Replace("equals", "in");
                            //ValueTemp = "(" + Value[i].Text + ")";
                        }

                       q += tempq; 
                   }
                   
               }
               
           }

           if (latestreportscheckBox1.Checked)
           {
               q += @" and 
				(select count(sequenceid) from factschedules fs2 where extranetfilepath is not null and   fs2.labid=fs.labid and   fs2.sequenceid<=fs.sequenceid ) 
				  = (select count(sequenceid) from factschedules fs2 where extranetfilepath is not null and   fs2.labid=fs.labid )";
           }
           q = q.Replace("WHERE 1=1 and ", " WHERE ");


          // String skip = "Select * from FactSamples";
           MessageBox.Show(q);
           return q; 
        }

        private  String CSVtoSQL(String csv) 
        {
            String Field = csv.Split('_')[0].Replace("'", "''");
            String FieldSQL = FieldsArray[getFieldsArrayIndex(Field), 8];
            String Filtertext = csv.Split('_')[1].Replace("'", "''");
            String Filtervalue = csv.Split('_')[2].Replace("'", "''"); 

            String Filtertype =  FieldsArray[getFieldsArrayIndex(Field),3]  ;

            //MessageBox.Show(Field + ", " + Filtertext + ", " + Filtervalue + ", " + Filtertype + " for filter:" + FieldsArray[getFieldsArrayIndex(Field), 1]); 
            for (int numRows = 0; numRows < FilterArrayCount; numRows++)
            {
               // MessageBox.Show((FilterArray[numRows, 0] == Filtertype.Split('-')[0]).ToString() +" "+ (FilterArray[numRows, 1] == Filtertext)).ToString();
                if (FilterArray[numRows, 0] == Filtertype.Split('-')[0] && FilterArray[numRows, 1] == Filtertext) 
                {
                    if (Filtertype.Split('-')[0] == "List")
                    {
                        return (FieldSQL + " " + FilterArray[numRows, 2].Replace("$$$", Filtervalue)).Replace(",", "','");
                    }
                    else
                    {
                        return FieldSQL + " " + FilterArray[numRows, 2].Replace("$$$", Filtervalue);
                    }
                }
            }

            return "NOT FOUND"+csv ;

        }

        private void fillListChoices(String query, int FilterIndex)
        {
          //  MessageBox.Show(query);
            //FilterlistBox2.Items.Clear();
            //SqlConnection connection = new SqlConnection("Data Source=SQL2012;Initial Catalog=Datawarehouse;Integrated Security=True;Connection Timeout=60");
            
            
            /*SqlConnection connection = new SqlConnection("Server=SQL2012;Database=Datawarehouse;User Id=bdeyoungApplicationsReadOnly;Password=PASSWORDHERE;"); 
                  



            using (connection)
            {
                SqlCommand command = new SqlCommand( query, connection);
                connection.Open();

                SqlDataReader reader = command.ExecuteReader();

                Value[FilterIndex].Items.Clear();

                if (reader.HasRows)
                {
                    while (reader.Read())
                    {
                        Value[FilterIndex].Items.Add(reader.GetString(0));  
                    }
                }
                else
                {
                    Console.WriteLine("No rows found.");
                }
                reader.Close();
            }
            */ 

            string strConnection = "host=db4free.net;user=dbadmin;password=dbadmin;database=datawarehouse490;";

            MySql.Data.MySqlClient.MySqlConnection conn;
            MySql.Data.MySqlClient.MySqlCommand cmd;

            conn = new MySql.Data.MySqlClient.MySqlConnection();
            cmd = new MySql.Data.MySqlClient.MySqlCommand();

            conn.ConnectionString = strConnection;

            try
            {
                conn.Open();
                cmd.Connection = conn;

                cmd.CommandText = query;  //"INSERT INTO FactSamples VALUES("++");";
                cmd.Prepare();
 
                /*for (int i = 1; i <= 1; i++)
                {
                    cmd.Parameters["@number"].Value = i;

                    cmd.ExecuteNonQuery();
                }*/

               MySqlDataReader reader =  cmd.ExecuteReader();

               
                Value[FilterIndex].Items.Clear();

                if (reader.HasRows)
                {
                    while (reader.Read())
                    {
                        Value[FilterIndex].Items.Add(reader.GetString(0));
                    }
                }
                else
                {
                    Console.WriteLine("No rows found.");
                }



            }
            catch (MySql.Data.MySqlClient.MySqlException ex)
            {
                MessageBox.Show("Error " + ex.Number + " has occurred: " + ex.Message,
                    "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
           
        }

        private void DatabaseCall(String Query)
        {

            string strConnection = "host=db4free.net;user=dbadmin;password=dbadmin;database=datawarehouse490;";

            MySql.Data.MySqlClient.MySqlConnection conn;
            MySql.Data.MySqlClient.MySqlCommand cmd;

            conn = new MySql.Data.MySqlClient.MySqlConnection();
            cmd = new MySql.Data.MySqlClient.MySqlCommand();

            conn.ConnectionString = strConnection;

            try
            {
                conn.Open();
                cmd.Connection = conn;

                cmd.CommandText = Query;  //"INSERT INTO FactSamples VALUES("++");";
                cmd.Prepare();
 
                MySqlDataReader reader =  cmd.ExecuteReader();

                DataTable table = new DataTable();
                table.Load(reader);
                 
                ResultsdataGridView1.DataSource = table;
           
            }
            catch (MySql.Data.MySqlClient.MySqlException ex)
            {
                MessageBox.Show("Error " + ex.Number + " has occurred: " + ex.Message,  "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
 
            StepThreeGroupBox.Visible = true;
            CartgroupBox.Visible = true;

            /*SqlConnection connection = new SqlConnection("Server=SQL2012;Database=Datawarehouse;User Id=bdeyoungApplicationsReadOnly;Password=5QIpk9ijpIHHHJqjxL45;Connect Timeout=500");
           

            using (connection)
            {
                SqlCommand command = new SqlCommand(Query, connection);
                connection.Open();
                
                SqlDataReader reader = command.ExecuteReader();

                DataTable table = new DataTable();
                table.Load(reader);

                reader.Close();
                reader.Dispose();
                connection.Close();
                connection.Dispose();
                command.Dispose();
                command = null;
                ResultsdataGridView1.DataSource = null;
                this.ResultsdataGridView1.Rows.Clear();
                ResultsdataGridView1.Columns.Clear();
                ResultsdataGridView1.Refresh();

                DataGridViewButtonColumn col = new DataGridViewButtonColumn();
                col.UseColumnTextForButtonValue = true;
                col.Text = "ADD";
                col.Name = "Report";
                col.Width = 45;
                col.Frozen = true; 
                ResultsdataGridView1.Columns.Add(col);

                DataGridViewButtonColumn col2 = new DataGridViewButtonColumn();
                col2.UseColumnTextForButtonValue = true;
                col2.Text = "View";
                col2.Name = "Report";
                col2.Width = 45;
                col2.Frozen = true; 
                ResultsdataGridView1.Columns.Add(col2);


                DataGridViewButtonColumn col4 = new DataGridViewButtonColumn();
                col4.UseColumnTextForButtonValue = true;
                col4.Text = "ADD";
                col4.Name = "Chain";
                col4.Width = 45;
                col4.Frozen = true;
                ResultsdataGridView1.Columns.Add(col4);

                DataGridViewButtonColumn col3 = new DataGridViewButtonColumn();
                col3.UseColumnTextForButtonValue = true;
                col3.Text = "View";
                col3.Name = "Chain";
                col3.Width = 45;
                col3.Frozen = true; 
                ResultsdataGridView1.Columns.Add(col3);

                ResultsdataGridView1.DataSource = table;

                int i = 4;
                for (int numRows = 0; numRows < FieldsArrayCount; numRows++)
                {
                    if (FieldsArray[numRows, 6] == "1")
                    {

                        if (FieldsArray[numRows, 2] == "Date")
                        {
                            ReplaceWithDateColumn(i, FieldsArray[numRows, 1], table);

                        }
                        
                        ResultsdataGridView1.Columns[i].HeaderCell.Value = FieldsArray[numRows, 1];
                        ResultsdataGridView1.Columns[i].Name = FieldsArray[numRows, 1];
                        ResultsdataGridView1.Columns[i].Width = int.Parse(FieldsArray[numRows, 4]);
                        ResultsdataGridView1.Columns[i].ReadOnly = true;

                        i++;
                    }

                }

                 
                ResultsdataGridView1.Columns["url"].Visible = false;
                ResultsdataGridView1.Columns["primaryMarkethide"].Visible = false;
                ResultsdataGridView1.Columns["coc"].Visible = false;

                connection.Close();
            }
            
            
            

            StepThreeGroupBox.Visible = true;
            CartgroupBox.Visible = true;



            CheckBlankButtons();
            */
        }

        private void ReplaceWithDateColumn(int index, String ColumnName, DataTable table)
        {
            table.Columns.Add(new DataColumn(ColumnName, typeof(DateTime)));
            DataColumn newCol = table.Columns[ColumnName];
            for (int row = 0; row < ResultsdataGridView1.RowCount; row++)
            {
                if (ResultsdataGridView1.Rows[row].Cells[index].Value.ToString() != "" && ResultsdataGridView1.Rows[row].Cells[index].Value.ToString().Length == 8)
                {
                    String Date1 = ResultsdataGridView1.Rows[row].Cells[index].Value.ToString();
                    int year = int.Parse(Date1.Substring(0, 4));
                    int month = int.Parse(Date1.Substring(4, 2));
                    int day = int.Parse(Date1.Substring(6, 2));
                    ResultsdataGridView1.Rows[row].Cells[ColumnName].Value = new DateTime(year, month, day);
                }
            }
            //ResultsdataGridView1.
            //table.Columns.RemoveAt(index-3);
            
            ResultsdataGridView1.Columns[index].Visible = false;
            ResultsdataGridView1.Columns[ColumnName].DisplayIndex = index; 
            //newCol.SetOrdinal(index - 3);

        }

        private void CheckBlankButtons()
        {
            for (int numRows = 0; numRows < ResultsdataGridView1.Rows.Count; numRows++)
            {
                if (ResultsdataGridView1.Rows[numRows].Cells["url"].Value.ToString() == "")
                {
                    DataGridViewButtonCell b = ResultsdataGridView1.Rows[numRows].Cells[0] as DataGridViewButtonCell;                   
                    b.UseColumnTextForButtonValue = false;
                    b = ResultsdataGridView1.Rows[numRows].Cells[1] as DataGridViewButtonCell;
                    b.UseColumnTextForButtonValue = false;
                }
 
                if (ResultsdataGridView1.Rows[numRows].Cells["coc"].Value.ToString() == "")
                 {
                    DataGridViewButtonCell b = ResultsdataGridView1.Rows[numRows].Cells[2] as DataGridViewButtonCell;
                    b.UseColumnTextForButtonValue = false;
                    b = ResultsdataGridView1.Rows[numRows].Cells[3] as DataGridViewButtonCell;
                    b.UseColumnTextForButtonValue = false;
                 }
            }
        }

        private void StepOneResetButton_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < SelectedItemsListBox.Items.Count; i++)
            {
                FieldsArray[getFieldsArrayIndex(SelectedItemsListBox.Items[i].ToString()), 6] = "0";
            }
            FillChoiceListBoxes();

        }

        private void StepTwoResetButton_Click(object sender, EventArgs e)
        {
            //FilterslistBox.Items.Clear();
        }

        private void StepTwoNextButton_Click(object sender, EventArgs e)
        {
            ////////Outlook.Application outlookApp = new Outlook.Application();
            ValidateFilters(); 
            Console.WriteLine(BuildQuery());
            DatabaseCall(BuildQuery());

            countfoundlabel1.Text = ResultsdataGridView1.RowCount.ToString() + " Results Found"; 
            ///////System.Diagnostics.Process.Start("C:\\Program Files\\Microsoft Office 15\\root\\office15\\OUTLOOK.EXE", "/a C:\\script.txt /m name@address.com");
            /*Outlook.MailItem mail = outlookApp.CreateItem(
     Outlook.OlItemType.olMailItem) as Outlook.MailItem;
            mail.Subject = "Quarterly Sales Report FY06 Q4";
            Outlook.AddressEntry currentUser =
                outlookApp.Session.CurrentUser.AddressEntry;
            if (currentUser.Type == "EX")
            {
                Outlook.ExchangeUser manager =
                    currentUser.GetExchangeUser().GetExchangeUserManager();
                // Add recipient using display name, alias, or smtp address
                mail.Recipients.Add(manager.PrimarySmtpAddress);
                mail.Recipients.ResolveAll();
                mail.Attachments.Add(@"c:\script.txt",
                    Outlook.OlAttachmentType.olByValue, Type.Missing,
                    Type.Missing);
                mail.Send();
            }*/
        }

        private void Exportbutton_Click(object sender, EventArgs e)
        {
            String Timestamp = string.Format("{0:yyyy-MM-dd_hh-mm-ss-tt}", DateTime.Now);
            String dir = "\\\\sbs1\\Shared\\Temp\\" + Timestamp + "\\";
            String FinalPath = dir + "QueryResults.xls";
            System.IO.Directory.CreateDirectory(dir); 
            export_datagridview_to_excel(ResultsdataGridView1, FinalPath); // @"//sbs1/Shared/Temp/test.xls");
            System.Diagnostics.Process.Start(FinalPath);
        }

        private void Download_Click(object sender, EventArgs e)
        {
            


            String filename = "Default.pdf";
            SaveFileDialog saveFileDialog1 = new SaveFileDialog();
            saveFileDialog1.InitialDirectory = @"C:\";
            saveFileDialog1.Title = "Save pdf Files";
            //saveFileDialog1.CheckFileExists = true;
            //saveFileDialog1.CheckPathExists = true;
            saveFileDialog1.DefaultExt = "pdf";
            saveFileDialog1.Filter = "Pdf Files|*.pdf";
            saveFileDialog1.FilterIndex = 2;
            saveFileDialog1.RestoreDirectory = true;

            if (saveFileDialog1.ShowDialog() == DialogResult.OK)
            {
                filename = saveFileDialog1.FileName;
            }

            String FinalName = DownloadAndMerge();

            System.IO.File.Copy(FinalName, filename);
            System.IO.File.Delete(FinalName);
        }

        private void Print_Click(object sender, EventArgs e)
        {
            String FinalName = DownloadAndMerge();
            System.Diagnostics.Process.Start(FinalName);
        }

        private void Email_Click(object sender, EventArgs e)
        {
            //DownloadAndMerge();
            //String FinalName = DownloadAndMerge();    //"\\\\sbs1\\Shared\\Temp\\2014-07-03_09-22-45-AM\\LabReports.pdf";  //
            //Form f = new EmailForm(FinalName,ENCRYPT_EMAIL);
            //f.Show();
            
        }

        private String DownloadAndMerge()
        {

            //if there are items in list box 
            // create folder timestamo in //sbs1/Temp 
            //for each item in list box 
            //download and rename 1,2,3,4
            //merge the whole folder 
            String Timestamp = "2014-07-03_09-22-45-AM";
            String dir = "\\\\sbs1\\Shared\\Temp\\" + Timestamp + "\\";
            String FinalPath = dir + "SearchResults.pdf";
            if (listBox1.Items.Count > 0)
            {
                Timestamp = string.Format("{0:yyyy-MM-dd_hh-mm-ss-tt}", DateTime.Now);
                dir = "\\\\sbs1\\Shared\\Temp\\" + Timestamp + "\\";
                FinalPath = dir + "SearchResults.pdf";
                System.IO.Directory.CreateDirectory(dir);
            }
             ENCRYPT_EMAIL = false; 
            for (int i = 0; i < listBox1.Items.Count; i++)
            {
                Process scriptProc = new Process();
                //scriptProc.StartInfo.FileName = @"\\10097-pc\c$\Users\bdeyoung\Desktop\saver2.vbs";
                scriptProc.StartInfo.FileName = @"\\sbs1\shared\Temp\saver2.vbs";
                scriptProc.StartInfo.Arguments = "\"" + listBox1.Items[i].ToString().Split(',')[0] + "\" \"" + i.ToString("0000000000") + "\" \"" + dir + "\"";
                scriptProc.StartInfo.UseShellExecute = true;
                scriptProc.StartInfo.WindowStyle = ProcessWindowStyle.Hidden; 
                scriptProc.Start();
                scriptProc.WaitForExit();
                scriptProc.Close();
               // MessageBox.Show(listBox1.Items[i].ToString().Split(',')[1]); 
                if (listBox1.Items[i].ToString().Split(',')[1] == "Therapeutic") { ENCRYPT_EMAIL = true; }
            }

            Merge(dir, FinalPath);
            return FinalPath;
        }
               
        private void Merge(String Folder,String EndPath )
        {
            string[] lstFiles = Directory.GetFiles(Folder, "*.pdf");
            for (int y = 0; y < lstFiles.Count(); y++)
            {
                Console.WriteLine(lstFiles[y]);
            }

            PdfReader reader = null;
            Document sourceDocument = null;
            PdfCopy pdfCopyProvider = null;
            PdfImportedPage importedPage;
            string outputPdfPath = EndPath;


            sourceDocument = new Document();
            pdfCopyProvider = new PdfCopy(sourceDocument, new System.IO.FileStream(outputPdfPath, System.IO.FileMode.Create));

            //Open the output file
            sourceDocument.Open();

            try
            {
                //Loop through the files list
                for (int f = 0; f < lstFiles.Length; f++)
                {
                    //MessageBox.Show(lstFiles[f]);
                    int pages = get_pageCcount(lstFiles[f]);

                    reader = new PdfReader(lstFiles[f]);
                    //Add pages of current file
                    for (int i = 1; i <= pages; i++)
                    {
                        importedPage = pdfCopyProvider.GetImportedPage(reader, i);
                        pdfCopyProvider.AddPage(importedPage);
                    }

                    reader.Close();
                    File.Delete(lstFiles[f]); 
                }
                //At the end save the output file
                sourceDocument.Close();
            }
            catch (Exception ex)
            {
                throw ex;
            }

        }

        private int get_pageCcount(string file)
        {
            using (StreamReader sr = new StreamReader(File.OpenRead(file)))
            {
                Regex regex = new Regex(@"/Type\s*/Page[^s]");
                MatchCollection matches = regex.Matches(sr.ReadToEnd());

                return matches.Count;
            }
        }

        private void openUrl(string url)
        {
            if (url != "")
            {
                ProcessStartInfo sInfo = new ProcessStartInfo(url);
                Process.Start(sInfo);
            }

        }
         
        private void Removebutton4_Click(object sender, EventArgs e)
        {
            if (listBox1.SelectedItem == null) { return; }
            listBox1.Items.Remove(listBox1.SelectedItems[0]);
        }

        private void removeallbutton5_Click(object sender, EventArgs e)
        {
            listBox1.Items.Clear();
        }

        private void LisboxMoveUp_Click(object sender, EventArgs e)
        {
            if (listBox1.SelectedItem == null)
            { return; }


            var idx = listBox1.SelectedIndex;
            var elem = listBox1.SelectedItem;
            if (idx > 0)
            {
                listBox1.Items.RemoveAt(idx);
                listBox1.Items.Insert(idx - 1, elem);
                listBox1.SetSelected(idx - 1, true);
            }
        }

        private void ListboxMoveDown_Click(object sender, EventArgs e)
        {
            if (listBox1.SelectedItem == null)
            { return; }


            var idx = listBox1.SelectedIndex;
            var elem = listBox1.SelectedItem;
            if (idx < listBox1.Items.Count - 1)
            {
                listBox1.Items.RemoveAt(idx);
                listBox1.Items.Insert(idx + 1, elem);
                listBox1.SetSelected(idx + 1, true);
            }
        }

        private void ViewURL_Click(object sender, EventArgs e)
        {
            if (listBox1.SelectedItem == null)
            { return; }

            openUrl(listBox1.SelectedItem.ToString().Split(',')[0] );
        }

        private void listBox1_DoubleClick(object sender, EventArgs e)
        {
            if (listBox1.SelectedItem == null)
            { return; }

            openUrl(listBox1.SelectedItem.ToString());
        }

        private void ResultsdataGridView1_CellDoubleClick(object sender, DataGridViewCellEventArgs e)
        {
            if (e.RowIndex == -1) { return; }
            if (e.ColumnIndex == -1) { return; }
            Int32 selectedRowCount = ResultsdataGridView1.Rows.GetRowCount(DataGridViewElementStates.Selected);
            String url = ResultsdataGridView1.Rows[e.RowIndex].Cells["url"].Value.ToString();
            String Chain = ResultsdataGridView1.Rows[e.RowIndex].Cells["coc"].Value.ToString(); 
            String market = ResultsdataGridView1.Rows[e.RowIndex].Cells["primaryMarkethide"].Value.ToString();
            if (e.ColumnIndex == 0)
                {
                    if (url != "")
                    {
                        listBox1.Items.Add(url + "," + market);
                    }

                }
                else if (e.ColumnIndex == 1)
                {
                    if (url != "")
                    {
                       openUrl(url);
                    }
                }
                else if (e.ColumnIndex == 2) 
                {
                    if (Chain != "")
                    {
                        listBox1.Items.Add(Chain + "," + market);
                    }
                }
                else if (e.ColumnIndex == 3)
                {
                    if (Chain != "")
                    {
                        openUrl(Chain);
                    }
                }
                else { } 
            

        }

        private void filterdateTimePicker1_ValueChanged(object sender, EventArgs e)
        {
            //if ( //filterdateTimePicker1.Focused ) {SendKeys.Send(".");} 
        }

        private void filterdataGridView1_RowsAdded(object sender, DataGridViewRowsAddedEventArgs e)
        {
           // int x = filterdataGridView1.Columns["field"].Width + filterdataGridView1.Columns["filter"].Width; 
          //  int y = filterdataGridView1.Rows[e.RowIndex].Height;

            CheckBoxComboBox cb = new CheckBoxComboBox();
            Location = new Point(500,500);
            cb.Visible = true;
            cb.Show();
            cb.BringToFront();
            cb.Focus();
            Controls.Add(cb); 
            
            
        }
        //export_datagridview_to_excel(ResultsdataGridView1,)

        public void export_datagridview_to_excel(DataGridView dgv, string excel_file)
        {
            int cols;
            //open file 
            //StreamWriter wr = new StreamWriter(excel_file);
            using (StreamWriter wr = File.AppendText(excel_file))
            {
                //determine the number of columns and write columns to file 
                cols = dgv.Columns.Count;
                for (int i = 4; i < cols; i++)
                {
                    if (dgv.Columns[i].Visible == true)
                    {
                        wr.Write(dgv.Columns[i].Name.ToString().ToUpper() + "\t");
                    }
                }

                wr.WriteLine();

                //write rows to excel file 
                for (int i = 0; i < (dgv.Rows.Count); i++)
                {
                    for (int j = 4; j < cols; j++)
                    {
                        if ( dgv.Columns[j].Visible == true) 
                        {
                            if (dgv.Rows[i].Cells[j].Value != null)
                                wr.Write(dgv.Rows[i].Cells[j].Value + "\t");
                            else
                            {
                                wr.Write("\t");
                            }   
                        }

                    }

                    wr.WriteLine();
                }

                //close file 
                wr.Close();
            }
        } 
        
        private void DrawFilterLines()
        {
          
            for (int i = 0; i < Field.Length; i++)
            {
               // if (add[i].Visible || !add[i].Visible)
                //{
                   // add[i].Hide();
                    Field[i].Show();
                    Filter[i].Show();
                    Value[i].Show();
                   // remove[i].Show();
                    valid[i].Show();
                    
               // }
            }
        }

        private void ResultsdataGridView1_ColumnHeaderMouseDoubleClick(object sender, DataGridViewCellMouseEventArgs e)
        {
            CheckBlankButtons();
        }

        private void ResetFilters_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < Value.Length; i++)
            {
                Value[i].Text = "";
                Value[i].ClearSelection();
            }
        }

        private void resetFilters2_Click(object sender, EventArgs e)
        {
            for (int i = 0; i < Value.Length; i++)
            {
                Value[i].Text = "";
                Value[i].ClearSelection();
                Field[i].Text = "";
                Field[i].SelectedIndex = -1; 
                Filter[i].Text = "";
                Filter[i].SelectedIndex = -1; 
            }
        }

        private void button1_Click(object sender, EventArgs e)
        {
            MailMessage mail = new MailMessage(WindowsIdentity.GetCurrent().Name.Replace("FORENSICFLUIDS\\", "") + "@forensicfluids.com", "bdeyoung@forensicfluids.com");
            SmtpClient client = new SmtpClient();
            client.Port = 25;
            client.DeliveryMethod = SmtpDeliveryMethod.Network;
            client.UseDefaultCredentials = true;
            client.Host = "mail.forensicfluids.com";
            //mail.CC.Add(new MailAddress(textBox4.Text));
            mail.Subject = "LAB REPORT SERACH TOOL  query  ";
            mail.Body = BuildQuery(); 

            

            client.Send(mail);
            MessageBox.Show("Message Sent to IT");
 
 
        }

        private void addallreportsbutton2_Click(object sender, EventArgs e)
        {
            String url = "";
            String market = "";

            for (int numRows = 0; numRows < ResultsdataGridView1.Rows.Count; numRows++)
            {
                if (ResultsdataGridView1.Rows[numRows].Cells["url"].Value.ToString() != "")
                {
                    url = ResultsdataGridView1.Rows[numRows].Cells["url"].Value.ToString();
                    market = ResultsdataGridView1.Rows[numRows].Cells["primaryMarkethide"].Value.ToString();
                    listBox1.Items.Add(url + "," + market);
                }
            }
        }

        private void addallchainsbutton3_Click(object sender, EventArgs e)
        {
            String Chain = "";
            String market = "";

            for (int numRows = 0; numRows < ResultsdataGridView1.Rows.Count; numRows++)
            {
                if (ResultsdataGridView1.Rows[numRows].Cells["coc"].Value.ToString() != "")
                {
                    Chain = ResultsdataGridView1.Rows[numRows].Cells["coc"].Value.ToString();
                    market = ResultsdataGridView1.Rows[numRows].Cells["primaryMarkethide"].Value.ToString();
                    listBox1.Items.Add(Chain + "," + market);
                }
            }
        }

        private void addallbothbutton4_Click(object sender, EventArgs e)
        {
            String url = "";
            String Chain = "";
            String market = "";

            for (int numRows = 0; numRows < ResultsdataGridView1.Rows.Count; numRows++)
            {
                if (ResultsdataGridView1.Rows[numRows].Cells["url"].Value.ToString() != "")
                {
                    url = ResultsdataGridView1.Rows[numRows].Cells["url"].Value.ToString();
                    market = ResultsdataGridView1.Rows[numRows].Cells["primaryMarkethide"].Value.ToString();
                    listBox1.Items.Add(url + "," + market);
                }

                if (ResultsdataGridView1.Rows[numRows].Cells["coc"].Value.ToString() != "")
                {
                    Chain = ResultsdataGridView1.Rows[numRows].Cells["coc"].Value.ToString();
                    market = ResultsdataGridView1.Rows[numRows].Cells["primaryMarkethide"].Value.ToString();
                    listBox1.Items.Add(Chain + "," + market);
                }
            }

        }

        private void button2_Click(object sender, EventArgs e)
        {
            StepOneGroupBox.Visible = true;
            StepOneGroupBox.BringToFront();
            StepTwoGroupBox.SendToBack();
            StepTwoGroupBox.Visible = false;
            button2.Enabled = false;
            StepSwitchbutton2.Enabled = true;
        }

        private void StepSwitchbutton2_Click(object sender, EventArgs e)
        {
            StepTwoGroupBox.Visible = true; 
            StepOneGroupBox.Visible = false;
            StepTwoGroupBox.BringToFront();
            StepOneGroupBox.SendToBack();
            StepSwitchbutton2.Enabled = false;
            button2.Enabled = true; 

        }

        private void QueryBuilder_SizeChanged(object sender, EventArgs e)
        {
            bool isBigWindow = true;
            int Spacer = 10; 
           /// MessageBox.Show(this.Width.ToString()); 
            if ( this.Width < 1000)
            {
                isBigWindow = false;
                StepTwoGroupBox.Location = new Point(StepOneGroupBox.Location.X, StepOneGroupBox.Location.Y);

                button2.Enabled = false;
                StepSwitchbutton2.Enabled = true;
                

            }
            else
            {
                isBigWindow = true;
                StepTwoGroupBox.Location = new Point(StepOneGroupBox.Location.X+StepOneGroupBox.Width + Spacer, StepOneGroupBox.Location.Y + Spacer); 
                
            }
            StepOneGroupBox.Visible = true; 
            StepTwoGroupBox.Visible = isBigWindow; 
            button2.Visible = !isBigWindow;
            StepSwitchbutton2.Visible = !isBigWindow;

            
            StepThreeGroupBox.Width =  this.Width - 5;
            ResultsdataGridView1.Width = StepThreeGroupBox.Width - 15; 


        }
    }
}
